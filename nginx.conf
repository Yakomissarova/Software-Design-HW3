events {
    worker_connections 1024;
}

http {
    server {
        listen 80;

        # ---------- Корневая заглушка ----------
        location = / {
            return 200 'API Gateway is running. Use /storage, /check or /scalar';
            add_header Content-Type text/plain;
        }

        # ---------- StorageService: префиксный доступ ----------
        # /storage/... -> в storage-service
        location /storage/ {
            proxy_pass http://storage-service:8080/;
            proxy_set_header Host $host;
        }

        # OpenAPI для Storage (используется Scalar)
        location /storage/openapi.json {
            proxy_pass http://storage-service:8080/swagger/v1/swagger.json;
        }

        # ---------- CheckService: префиксный доступ ----------
        # /check/... -> в check-service
        location /check/ {
            proxy_pass http://check-service:8080/;
            proxy_set_header Host $host;
        }

        # OpenAPI для Check (используется Scalar)
        location /check/openapi.json {
            proxy_pass http://check-service:8080/swagger/v1/swagger.json;
        }

        # ---------- Маршруты для Scalar (без префикса) ----------
        # /files        -> StorageService
        location = /files {
            proxy_pass http://storage-service:8080/files;
            proxy_set_header Host $host;
        }

        # /submissions  -> CheckService
        location = /submissions {
            proxy_pass http://check-service:8080/submissions;
            proxy_set_header Host $host;
        }

        # /assignments/... -> CheckService
        location /assignments/ {
            proxy_pass http://check-service:8080/assignments/;
            proxy_set_header Host $host;
        }

        # ---------- Scalar UI ----------
        location = /scalar {
            return 301 $scheme://$http_host/scalar/;
        }

        location /scalar/ {
            proxy_pass http://scalar:8080/;
        }
    }
}
